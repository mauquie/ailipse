<?php// Si la classe est déjà définie, on ne la rédéfinie pas (sécurité)if(!class_exists("Annonce")){	// Création de la classe Annonce	class Annonce	{		// Attribut de la classe Annonce		private $_bdd;				// Déclaration du constructeur de la classe		public function __construct()		{			$this->_bdd=new Bdd;		}				// Méthode de classe qui affiche le menu lié aux annonces		public function menuAnnonce()		{			// On retourne l'affichage du menu			return ('<div class="demo-card-wide mdl-card mdl-shadow--2dp">						<div class="mdl-card__title mdl-card-annonces__background animated slideInDown">						<h2 class="mdl-card__title-text">Petites annonces</h2>					</div>										<div class="mdl-card__supporting-text card-background">						<h5 class="animated fadeIn">Sélectionnez une action</h5>						<br />											<div class="content-grid mdl-grid hover01 column animated zoomInDown">							<div class="mdl-cell" style="margin-left: 25px; margin-bottom: 50px;">								<figure><a href="index.php?d=annonces&a=visualiser_annonce"><img width="250" height="200" src="vue/images/visualiser.png" /></a></figure>								<span>Visualiser les annonces</span>							</div>																						<div class="mdl-cell"  style="margin-bottom: 50px;">													<figure><a href="index.php?d=annonces&a=creer_annonce"><img width="250" height="200" src="vue/images/ajouter.png" /></a></figure>													<span>Proposer une annonce</span>												</div>																						<div class="mdl-cell"  style="margin-bottom: 50px;">													<figure><a href="index.php?d=annonces&a=supprimer_annonce"><img width="250" height="200" src="vue/images/supprimer.png" /></a></figure>													<span>Supprimer une annonce</span>												</div>											</div>										</div>						');					}		// Méthode de classe qui affiche le menu lié aux annonces		public function ajouterAnnonce()		{			// Connexion à la base de données			$connect=$this->_bdd->openBDD();	// Ouverture de la BDD avec l'objet créé dans session.php qui est accessible par le noyau						// On définit la timezone sur laquelle se baser pour la date			mysqli_set_charset($connect,"utf8");			date_default_timezone_set('Europe/Brussels');						// Initialisation des variables contenant les inputs des listes déroulantes			$deroulant_marque = "";			$deroulant_modele = "";			$deroulant_taille = "";			$deroulant_annee = "";			$deroulant_surface = "";			$deroulant_ptv = "";			$deroulant_localisation = "";						// Récupération de la table marque dans la base de données			$query="SELECT id, nom FROM `fabricant`";			$result = mysqli_query($connect ,$query);			while($row = mysqli_fetch_array($result))			{				// Récupération et stockage des noms des fabriquants				$deroulant_marque = $deroulant_marque."<option value=$row[0]>$row[1]</option>";				// Récupération des ids des fabriquants				$id_const = $row[0];			}						// Récupération des années possibles pour laisser une annonce			$annee_courante = date('Y');			for($x=0;$x<16;$x++)			{				// On récupère les 15 dernières années				$annee = intval($annee_courante)+($x-15);				// On stocke la liste des années possibles				$deroulant_annee = $deroulant_annee."<option value=".$annee.">".$annee."</option>";			}						// Récupération de la table surface dans la base de données			$query="SELECT * FROM `annonces_surface`";			$result = mysqli_query($connect ,$query);			while($row = mysqli_fetch_array($result))			{				// On récupère les données et on stocke la liste des surfaces possibles				$deroulant_surface = $deroulant_surface."<option value=$row[1]>$row[1]</option>";			}						// Récupération de la table ptv dans la base de données			$query="SELECT * FROM `annonces_ptv`";			$result = mysqli_query($connect ,$query);			while($row = mysqli_fetch_array($result))			{				// On récupère les données et on stocke la liste des ptv possibles				$deroulant_ptv = $deroulant_ptv."<option value=$row[1]>$row[1]</option>";			}						// Récupération de la table localisation dans la base de données trié par ordre ascendant			$query="SELECT * FROM `annonces_localisation` ORDER BY id ASC";			$result = mysqli_query($connect ,$query);			while($row = mysqli_fetch_array($result))			{				// On formate les localisations pour que les espaces soient remplacés par des underscores				$format = str_replace(" ", '_', $row[1]);				// On stocke la liste des localisations possibles				$deroulant_localisation = $deroulant_localisation."<option value=$format>$row[1]</option>";			}									// On ferme la connexion à la base de données			$this->_bdd->closeBDD();						// On retourne l'affichage lié à l'ajout d'une annonce			return('					<div class="demo-card-wide mdl-card mdl-shadow--2dp">											<div class="mdl-card__title mdl-card-annonces__background animated slideInDown">							<h2 class="mdl-card__title-text">Publication de petites annonces</h2>						</div>											<div class="mdl-card__supporting-text card-background">												<h5 class="animated slideInLeft">Caractéristiques</h5>																						<div class="content-grid mdl-grid">								<div class="mdl-cell--6-col animated slideInLeft">														<h6>Type d\'annonce *</h6>														<form action="index.php?d=annonces&a=confirm_annonce" method="post" enctype="multipart/form-data">										<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-vente">											<input type="radio" id="option-vente" class="mdl-radio__button" name="type_annonce" value="1" checked>											<span class="mdl-radio__label">Vente</span>										</label>															&nbsp;&nbsp;&nbsp;															<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-achat">											<input type="radio" id="option-achat" class="mdl-radio__button" name="type_annonce" value="2">											<span class="mdl-radio__label">Achat</span>										</label>															<br/><br/>														<h6>Marque *</h6>														<select id="marque" class="nice-select" name="marque" onchange="annonce_select_marque()">										<option value="-2">Sélectionnez une marque</option>										'.$deroulant_marque.'									</select>														<br/><br/>														<h6>Modèle *</h6>														<select id="modele" style="padding-right: 40px;" class="nice-select" name="modele" onchange="annonce_select_modele()">										<option value="-2">Sélectionnez un modèle</option>										'.$deroulant_modele.'									</select>														<br/><br/>														<h6>Taille *</h6>														<select style="padding-right: 60px;" id="taille" class="nice-select" name="taille" onchange="affich()">										<option value="-2">Sélectionnez la taille</option>										'.$deroulant_taille.'									</select>														<br/><br/>													</div>													<div class="mdl-cell--6-col animated slideInLeft">														<h6>Année *</h6>														<select style="padding-right: 60px;" id="annee" class="nice-select" name="annee" onchange="affich()">										<option value="-2">Sélectionnez une année</option>										'.$deroulant_annee.'									</select>														<br/><br/>														<h6>Surface</h6>														<select id="surface" class="nice-select" style="padding-right: 62px;" name="surface" onchange="affich()">										<option value="-2">Sélectionnez la surface</option>										'.$deroulant_surface.'									</select>														<br/><br/>														<h6>PTV (max)</h6>														<select id="ptv" style="padding-right: 75px;" class="nice-select" name="ptv" onchange="affich()">										<option value="-2">Sélectionnez le poids</option>										'.$deroulant_ptv.'									</select>														<br/><br/>														<h6>Localisation *</h6>														<select id="localisation" style="padding-right: 38px;" class="nice-select" name="localisation" onchange="affich()">										<option value="-2">Sélectionnez votre région</option>										'.$deroulant_localisation.'									</select>													</div>													<div class="mdl-cell--12-col animated slideInUp"><br/><hr/><br/></div>													<div class="mdl-cell--6-col animated slideInUp">													<h5 class="animated slideInLeft">Mise en forme</h5>													<br/>														<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">										<input name="titre" class="mdl-textfield__input" type="text" id="titre" required="required">										<label class="mdl-textfield__label" for="titre">Titre de votre annonce *</label>									</div>														<br/>													    <div class="mdl-textfield mdl-js-textfield">								  	  <textarea class="mdl-textfield__input" type="text" maxlength="500" rows= "10" id="contenu_annonce" name="contenu_annonce" required="required" ></textarea>								  	  <label class="mdl-textfield__label" for="sample5" style="color:#d50000; font-size: 12px;">Contenu de votre annonce *</label>								    </div>																				<br/>														<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">										<input class="mdl-textfield__input" name="prix" type="number" id="prix" required="required">										<label class="mdl-textfield__label" for="prix">Prix du bien *</label>									</div>														  <strong>€</strong>													</div>													<div class="mdl-cell--6-col animated slideInRight">																			<h6>Ajouter une photo *</h6>														<input name="photos[]" type="file" style="display:none" id="upload-image" multiple="multiple"></input>														<div id="upload" class="drop-area">														   Cliquez-ici et ajoutez une ou plusieurs images simultanément (3 maximum)														</div>														<div id="thumbnail"></div>														<h6>Contact par téléphone ? *</h6>														<form action="index.php?d=annonces&a=confirm_annonce" method="post" enctype="multipart/form-data">										<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-telephone-oui">											<input type="radio" id="option-telephone-oui" class="mdl-radio__button" name="telephone" value="1" checked>											<span class="mdl-radio__label">Oui</span>										</label>															&nbsp;&nbsp;&nbsp;															<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-telephone-non">											<input type="radio" id="option-telephone-non" class="mdl-radio__button" name="telephone" value="0">											<span class="mdl-radio__label">Non</span>										</label>															<br/><br/>														<h6>Mettre en ligne ? *</h6>														<form action="index.php?d=annonces&a=confirm_annonce" method="post" enctype="multipart/form-data">										<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-online-oui">											<input type="radio" id="option-online-oui" class="mdl-radio__button" name="online" value="1" checked>											<span class="mdl-radio__label">Oui</span>										</label>															&nbsp;&nbsp;&nbsp;															<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-online-non">											<input type="radio" id="option-online-non" class="mdl-radio__button" name="online" value="0">											<span class="mdl-radio__label">Non</span>										</label>															<br/><br/>															<button name="submit" type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">											Valider votre annonce										</button>															<br/><br/>										<p><i>Les champs marqués d\'un « * » sont obligatoires.</i></p>															</form>									<div/>								</div>							</div>						</div>					<br/>');		}				// Méthode de la classe permettant la suppression d'une annonce		public function supprimerAnnonce($login_session)		{			// Connexion à la base de données			$connect=$this->_bdd->openBDD();			// On sélectionne les permissions de l'utilisateur présent sur la page de suppression des annonces			$result = $connect->query("SELECT permissions FROM clients WHERE email ='$login_session'");			while($row = $result->fetch_array()){				// On stocke les permissions de l'utilisateur dans une variable				$permissions = $row[0];			}									// On initialise la variable annonce qui stockera les données liées à l'affichage des annonces			$annonce = "";			// On initialise la variable supprimer_annonce qui stockera l'affichage			$supprimer_annonce = "";						// Si l'utilisateur est un administrateur			if($permissions == 3)			{				// On sélectionne toutes les annonces qui ont été activées par l'administrateur				$annonces="SELECT * FROM `annonces` WHERE active = 1";				$result=$connect->query($annonces);							}			// Si l'utilisateur est un simple utilisateur ou un opérateur			else			{				// On sélectionne toutes les annonces que l'utilisateur a publié				$annonces="SELECT * FROM `annonces` WHERE email = '$login_session'";				$result=$connect->query($annonces);			}						// On range toutes les annonces dans un tableau pour l'affichage			// On vérifie que le résultat soit bien un objet (présence d'annonces)			if(gettype($result)=="object")			{				while($row = $result->fetch_array())				{					// Traitements des données récupérées pour l'affichage					$list_photos = $row[5]; 			// image1.jpg,image2.png,image3.jpg					$photo = explode(",",$list_photos); // image1.jpg image2.png image3.jpg					$photos = ""; 						// Variable contenant l'affichage des photos					foreach ($photo as $key => $value){						if($photo[$key]!=""){							$photos .= "<img style='border:1px dotted darkgrey; margin: 2px;' src='vue/images/annonces/$photo[$key]' height='80px' width='80px'></img>";						}					}										// Si le type d'annonce est à 1 on stocke Vente sinon Achat					if ($row[4] == 1){$type = "Vente";} else{$type = "Achat";}										// On formate la localisation de manière à ce que les underscores présents soient enlevés (Ile_de_France => Ile de France)					$row[12] =  str_replace("_", " ",$row[12]);										// Tableau récapitulatif d'une annonce					$annonce = $annonce."					<tr id='$row[0]'>					<td class="."mdl-data-table__cell--non-numeric".">$row[13]</td>					<td>$row[1]</td>					<td>$row[2]</td>					<td>$photos</td>					<td>$row[18]</td>					<td>$row[3]€</td>					<td>$type</td>					<td>$row[6]</td>					<td>$row[7]</td>					<td>$row[8]</td>					<td>$row[9]</td>					<td>$row[12]</td>					<td>$row[14]</td>					</tr>";										// On stocke l'affichage de la page de suppression des annonces dans une variable					$supprimer_annonce = '<h5 class="animated fadeIn">Gérez les annonces publiées ou en cours de publication</h5>											<div class="content-grid mdl-grid">												<div class="mdl-cell">																				<table id="tableau" class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp animated fadeIn">														<thead>															<tr>																<th class="mdl-data-table__cell--non-numeric">Email</th>																<th>Titre</th>																<th>Contenu</th>																<th>Photos</th>																<th>Date</th>																<th>Prix</th>																<th>Type</th>																<th>Marque</th>																<th>Modèle</th>																<th>Taille</th>																<th>Année</th>																<th>Localisation</th>																<th>Téléphone</th>															</tr>													  </thead>																					<tbody>															'.$annonce.'														</tbody>													</table>																														<br/>																														<button onClick="delete_annonce('."'notPanel'".')" style="color: #F44336;" class="mdl-button mdl-js-button mdl-button--accent animated slideInLeft">														Supprimer													</button>';									}			}			// Si la variable contenant l'affichage est vide, on affiche un message comme quoi il dispose d'aucune annonce publiée sur l'application			if($supprimer_annonce == "")			{				$supprimer_annonce = '<div id="recherche_infructueuse" class="animated fadeIn">									<h3 style="text-align: center;">Impossible de gérer vos annonces</h3>									<h5 style="text-align: center;">Vous ne disposez actuellement d\'aucunes annonces publiées sur l\'application</h5>									<div class="noresult"><img src="vue/images/noresult.png"></img></div>									<div id="recherche_bouton_retour">										<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary" onclick="history.back();";" "style="margin-top: 5%;">											Retourner à la page précédente										</button></div></div>';			}									// On ferme la connexion à la base de données			$this->_bdd->CloseBDD();						// On retourne l'affichage avec la variable contenant le contenu dynamique de suppression des annonces			return(' <div class="demo-card-wide mdl-card mdl-shadow--2dp">						<div class="mdl-card__title mdl-card-annonces__background animated slideInDown">							<h2 class="mdl-card__title-text">Gestion des annonces</h2>						</div>											<div class="mdl-card__supporting-text card-background">												'.$supprimer_annonce.'																					</div>					</div>			');														}		// Méthode de la classe permettant la validation de la suppression d'une annonce		public function validationSuppressionAnnonce()		{			// On ouvre la connexion à la base de données			$connect = $this->_bdd->openBDD();						// On récupère les ids des annonces grâce au formulaire HTML de suppression des annonces			$id=$_GET["ids"];			// On initialise une variable contenant le chemin vers le dossier où sont stockées les photos des annonces			$dir_f =  "../../vue/images/annonces/";			// On transforme un string en array quand dans la chaîne de caractère présente des ; ; pour séparer les ids			$array=explode(";",$id);						//			for($i=0;$i<(count($array)-1);$i++)			{				// On initialise la variable tampon des photos				$photos="";				// On sélectionne dans la BDD le champ photo pour récupérer les photos propres à l'annonce				$sql="SELECT photo, email, titre FROM annonces WHERE id='$array[$i]'";				$result=$connect->query($sql);				while($row = $result->fetch_array())				{					// On transforme la chaîne de caratère en tableau pour trier sur chacunes des photos grâce à la virgule					$photos = explode(",",$row[0]);					$email = $row[1];					$titre = $row[2];					foreach ($photos as $key => $value){						// On supprime la photo du répertoire jusqu'à ce que la variable soit nulle						if($photos[$key]!=""){							unlink($dir_f.$photos[$key]);						}					}				}								// On sélectionne dans la BDD le champ active				$sql="SELECT active FROM annonces WHERE id='$array[$i]'";				$result=$connect->query($sql);				while($row = $result->fetch_array())				{					// Si l'annonce n'est pas activée					if ($row[0] == 0)					{						// On décrémente le compteur de notification des annonces						$sql="UPDATE notifications SET annonces = annonces-1 WHERE id = 1";						$connect->query($sql);					}				}				// On supprime toutes les annonces d'ou on recoit l'id				$sql="DELETE FROM annonces WHERE id='$array[$i]'";				$connect->query($sql);								// Préparation du mail pour avertir de la suppression de l'annonce à l'utilisateur				$to      = $email;				$subject = 'Création de votre annonce '.$titre.' sur le site Ailipse Technique';				$message = 'Votre annonce <strong>'.$titre.'</strong> a bien été supprimée. <br/><br/> Elle n\'apparaîtra plus sur le site à compter de maintenant.<br/><br/> Cet email est un message automatique, merci de ne pas y répondre. <br/><br/> <center><img src="http://www.ailipse-technique.fr/selAT/public/img/ailipse_logoweb.png"></img></center>';								$headers = "MIME-Version: 1.0" . "\r\n";				$headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";								// Envoi du mail				mail($to, $subject, $message, $headers);			}						// On ferme la connexion à la base de données			$this->_bdd->closeBDD();					}				// Méthode de la classe permettant de visualiser les annonces		public function visualiserAnnonces()		{			// Initialisation des variables contenant les valeurs des inputs (listes déroulantes)			$deroulant_region = "";			$deroulant_annee = "";			$deroulant_marque = "";			$deroulant_modele = "";			$deroulant_prix = "";						// On se connecte à la base de données			$connect=$this->_bdd->openBDD();			mysqli_set_charset($connect,"utf8");			// On paramètre la timezone par défaut pour récupérer la date du jour plus tard			date_default_timezone_set('Europe/Brussels');			// On sélectionne tous les champs de la table annonces_localisation triés par id ascendants			$result=$connect->query("SELECT * FROM `annonces_localisation` ORDER BY id ASC");						while($row = $result->fetch_array())			{				// On stocke dans la liste déroulante l'id et le nom de de la région				$deroulant_region .= '<option value="'.$row[0].'">'.$row[1].'</option>';			}			// Récupération de la table marque dans la base de données			$result=$connect->query("SELECT id, nom FROM `fabricant`");			while($row = mysqli_fetch_array($result))			{				// On stocke dans la liste déroulante l'id et le nom de de la marque				$deroulant_marque = $deroulant_marque."<option value=$row[0]>$row[1]</option>";				$id_const = $row[0];			}						// Récupération des années possibles pour un produit vendable			$annee_courante = date('Y');			// On récupère les 15 dernières années			for($x=0;$x<16;$x++)			{				$annee = intval($annee_courante)+($x-15);				// On stocke dans la liste déroulante les années possibles				$deroulant_annee = $deroulant_annee."<option value=".$annee.">".$annee."</option>";			}			// On stocke dans la liste déroulante la fourchette de prix min et la fourchette de prix max			for($x=0;$x<11;$x++){				if($x==10)	{$deroulant_prix .= "<option value=".$x*200 .">+".$x*200 ." €</option>";}				else		{$deroulant_prix .= "<option value=".$x*200 .">".$x*200 ." €</option>";}			}			// On renvoie l'affichage de la méthode de classe			return(' <link rel="stylesheet prefetch" href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:700">					 <link rel="stylesheet" href="vue/css/style_regions.css">					 <div class="demo-card-wide mdl-card mdl-shadow--2dp">							<div class="mdl-card__title mdl-card-annonces__background animated slideInDown">								<h2 class="mdl-card__title-text">Visualisation des annonces en ligne</h2>							</div>												<div class="mdl-card__supporting-text card-background">								<div class="content-grid mdl-grid">									<div class="mdl-layout mdl-cell--5-col mdl-cell--12-col-tablet mdl-cell--12-col-phone animated fadeIn">										<h5>Sélectionnez votre région :</h5>															<br/>															<section class="france animated bounce" style="margin-top: -5px;">											<a class="alsa" id="1" onclick="choixRegion(this.id)" href="#" title="Alsace">												<span class="s01">Al</span><span class="s02">sa</span><span class="s03">ce</span>											</a>											<a class="aqui" id="2" onclick="choixRegion(this.id)" href="#" title="Aquitaine">												<span class="s04">Aqu</span><span class="s05">ita</span><span class="s06">ine</span>											</a>											<a class="auve" id="3" onclick="choixRegion(this.id)" href="#" title="Auvergne">												<span class="s07">Auv</span><span class="s08">er</span><span class="s09">gne</span>											</a>											<a class="bour" id="5" onclick="choixRegion(this.id)" href="#" title="Bourgogne">												<span class="s10">Bou</span><span class="s11">rgog</span><span class="s12">ne</span>											</a>											<a class="bret" id="6" onclick="choixRegion(this.id)" href="#" title="Bretagne">												<span class="s13">Breta</span><span class="s14">gne</span>											</a>											<a class="cent" id="7" onclick="choixRegion(this.id)" href="#" title="Centre">												<span class="s15">Cen</span><span class="s16">tre</span>											</a>											<a class="cham" id="8" onclick="choixRegion(this.id)" href="#" title="Champagne-Ardenne">												<span class="s17">Cha</span><span class="s18">mp</span><span class="s19">agne-</span><span class="s20">Arden</span><span class="s21">ne</span>											</a>											<a class="cors" id="9" onclick="choixRegion(this.id)" href="#" title="Corse">												<span class="s22">Co</span><span class="s23">rs</span><span class="s24">e</span>											</a>											<a class="fran" id="10" onclick="choixRegion(this.id)" href="#" title="Franche-Comté">												<span class="s25">Fra</span><span class="s26">nche</span><span class="s27">-Com</span><span class="s28">te</span>											</a>											<a class="idfr" id="12" onclick="choixRegion(this.id)" href="#" title="Île-de-France">												<span class="s29">Ile-de</span><span class="s30">-France</span>											</a>											<a class="lang" id="13" onclick="choixRegion(this.id)" href="#" title="Languedoc-Roussillon">												<span class="s31">Lan</span><span class="s32">gue</span><span class="s33">doc-</span><span class="s34">Rous</span><span class="s35">sil</span><span class="s36">lon</span>											</a>											<a class="limo" id="14" onclick="choixRegion(this.id)" href="#" title="Limousin">												<span class="s37">Li</span><span class="s38">mou</span><span class="s39">sin</span>											</a>											<a class="lorr" id="15" onclick="choixRegion(this.id)" href="#" title="Lorraine">												<span class="s40">Lor</span><span class="s41">rai</span><span class="s42">ne</span>											</a>											<a class="mipy" id="16" onclick="choixRegion(this.id)" href="#" title="Midi-Pyrénées">												<span class="s43">Midi</span><span class="visuallyhidden">-</span><span class="s44">Pyre</span><span class="s45">nees</span>											</a>											<a class="npdc" id="17" onclick="choixRegion(this.id)" href="#" title="Nord-Pas-de-Calais">												<span class="s46">Nord</span><span class="visuallyhidden">-</span><span class="s47">Pas-de-Calais</span>											</a>											<a class="bnor" id="4" onclick="choixRegion(this.id)" href="#" title="Basse-Normandie">												<span class="s48">Basse</span><span class="visuallyhidden">-</span><span class="s49">Norm</span><span class="s50">andie</span>											</a>											<a class="hnor" id="11" onclick="choixRegion(this.id)" href="#" title="Haute-Normandie">												<span class="s51">Haute</span><span class="visuallyhidden">-</span><span class="s52">Normandie</span>											</a>											<a class="pdll" id="19" onclick="choixRegion(this.id)" href="#" title="Pays de la Loire">												<span class="s53">Pays</span><span class="visuallyhidden"> </span><span class="s54">de</span><span class="visuallyhidden"> </span><span class="s55">la</span><span class="visuallyhidden"> </span><span class="s56">Loi</span><span class="s57">re</span>											</a>											<a class="pica" id="20" onclick="choixRegion(this.id)" href="#" title="Picardie">												<span class="s58">Picar</span><span class="s59">die</span>											</a>											<a class="poit" id="21" onclick="choixRegion(this.id)" href="#" title="Poitou-Charentes">												<span class="s60">Poitou</span><span class="visuallyhidden">-</span><span class="s61">Chare</span><span class="s62">ntes</span>											</a>											<a class="paca" id="18" onclick="choixRegion(this.id)" href="#" title="Provence-Alpes-Côte d\'Azur">												<span class="s63">Pro</span><span class="s64">ven</span><span class="s65">ce-Alpes</span><span class="visuallyhidden">-</span><span class="s66">Cote</span><span class="visuallyhidden"> </span><span class="s67">d\'Azur</span>											</a>											<a class="rhon" id="22" onclick="choixRegion(this.id)" href="#" title="Rhône-Alpes">												<span class="s68">Rhone</span><span class="s69">-Alp</span><span class="s70">es</span>											</a>										</section>									</div>													<div class="mdl-cell--1-col">								</div>													<div class="mdl-cell--6-col animated fadeIn">									<h5>Affinez votre recherche :</h5>									<br/>									<div class="mdl-cell--6-col mdl-cell--4-col-phone animated fadeIn" style="float: left; width: 80%;">										<p>Zone de recherche :</p>										<form action="index.php?d=annonces&a=rechercher_annonce" method="post" enctype="multipart/form-data">											<select id="selRegion" style="width: 100%;" class="nice-select" name="selRegion">												<option value="-2">Toute la France</option>'					.$deroulant_region.					'</select>									</div>									<br/><br/><br/>									<div class="mdl-cell--6-col mdl-cell--4-col-phone animated fadeIn">									<br/><br/><br/>										<p>Marque et modèle de la voile :</p>									</div>														<div class="mdl-cell--3-col mdl-cell--2-col-phone animated fadeIn" style="float: left; width: 35%; margin-right: 5%;">										<select id="marque" style="width: 100%"; class="nice-select" onchange="annonce_select_marque()" name="marque">											<option value="-2">Marque</option>											'.$deroulant_marque.'										</select>									</div>									<div class="mdl-cell--3-col mdl-cell--2-col-phone animated fadeIn" style="float: left; width: 35%; margin-left: 5%;">										<select id="modele" style="width: 100%;"  class="nice-select" name="modele">											<option value="-2">Modèle</option>											'.$deroulant_modele.'										</select>									</div>														<br/><br/><br/>									<div class="mdl-cell--6-col mdl-cell--4-col-phone animated fadeIn">										<p>Critères de prix :</p>									</div>														<div class="mdl-cell--3-col mdl-cell--2-col-phone animated fadeIn" style="float: left; width: 35%; margin-right: 5%;">										<select id="prixMin" style="width: 100%" class="nice-select" name="prixMin">											<option value="-2">Prix min</option>											'.$deroulant_prix.'										</select>									</div>									<div class="mdl-cell--3-col mdl-cell--2-col-phone animated fadeIn" style="float: left; width: 35%; margin-left: 5%;">										<select id="prixMax" style="width: 100%" class="nice-select" name="prixMax">											<option value="-2">Prix max</option>											'.$deroulant_prix.'										</select>									</div>									<br/><br/><br/>									<div class="mdl-cell--6-col mdl-cell--4-col-phone animated fadeIn">										<p>Années entre :</p>									</div>									<div class="mdl-cell--3-col mdl-cell--2-col-phone animated fadeIn" style="float: left; width: 35%; margin-right: 5%;">										<select id="anneeMin" style="width: 100%" class="nice-select" name="anneeMin">											<option value="-2">Année min</option>											'.$deroulant_annee.'										</select>									</div>									<div class="mdl-cell--3-col mdl-cell--2-col-phone animated fadeIn" style="float: left; width: 35%; margin-left: 5%">										<select id="anneeMax" style="width: 100%" class="nice-select" name="anneeMax">											<option value="-2">Année max</option>											'.$deroulant_annee.'										</select>									</div>															<div class="mdl-cell--6-col mdl-cell--4-col-phone animated fadeIn" style="float: left; width: 80%">											<div class="rechercher">												<button style="width: 100%;" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored"><i class="mdl-color-text--blue-grey-200 material-icons" role="presentation">search</i> Rechercher</button>											</div>										</div>									</form>								</div>							</div>						</div>					</div>									');																						}		// Méthode de la classe permettant de lancer la recherche des annonces		public function rechercherAnnonces(){						// Ouverture de la connexion à la base de données			$connect = $this->_bdd->openBDD();						// Récupération et stockage des variables que l'on récupère par le biais du formulaire			$id_region = $_POST["selRegion"];										// ID de la région de recherche			$id_marque = $_POST["marque"];											// ID de la marque recherchée			$id_modele = $_POST["modele"];											// ID du modèle recherché			$prix_min = $_POST["prixMin"];											// Prix minimum			$prix_max = $_POST["prixMax"];											// Prix maximum			$annee_min = $_POST["anneeMin"];										// Année minimum			$annee_max = $_POST["anneeMax"];										// Année maximum						$conditions_sql = [];													// Initialisation de la variable qui stockera la requête finale						// Si la valeur de la région est différente de la valeur par défaut			if($id_region!=-2)			{				// On requête la base de données pour récupérer le nom de la région qui correspond à l'ID récupéré				$result = $connect->query("SELECT region FROM annonces_localisation WHERE id='$id_region'");				while($row = mysqli_fetch_array($result))				{					// On ajoute la région dans notre variable stockant la requête finale					array_push($conditions_sql,"localisation = '$row[0]'");				}			}						// Si la valeur de la marque est différente de la valeur par défaut			if($id_marque!=-2)			{				// On requête la base de données pour récupérer le nom du fabriquant qui correspond à l'ID récupéré				$result = $connect->query("SELECT nom FROM fabricant WHERE id='$id_marque'");				while($row = mysqli_fetch_array($result))				{					// On ajoute la marque dans notre variable stockant la requête finale					array_push($conditions_sql,"marque = '$row[0]'");				}				// Si la valeur de la requête est différente de la valeur par défaut et que la marque a été sélectionnée au préalable				if($id_modele!=-2)				{					// On requête la base de données pour récupérer le nom du modèle qui correspond à l'ID récupéré					$result = $connect->query("SELECT nom FROM voile WHERE id='$id_modele' AND id_const='$id_marque'");					while($row = mysqli_fetch_array($result))					{						// On ajoute le modèle dans notre variable stockant la requête finale						array_push($conditions_sql,"modele = '$row[0]'");					}				}			}						// Si les prix minimum et maximum sont mentionnés par l'utilisateur			if(($prix_min!=-2)&&($prix_max!=-2))			{				// On ajoute la tranche de prix dans notre variable stockant la requête finale				array_push($conditions_sql,"prix BETWEEN $prix_min AND $prix_max");								// Si le prix minimum est supérieur au prix maximum, on retourne une erreur				if($prix_min > $prix_max)				{					echo '					<script>						alert("Erreur : Le prix minimum doit être inférieur au prix maximum.");						location.href = "index.php?d=annonces&a=visualiser_annonce";					</script>';				}			}			// Si le prix minimum seulement est mentionné par l'utilisateur			else if($prix_min!=-2)			{				// On ajoute la tranche de prix dans notre variable stockant la requête finale (le prix des annonces sera forcément supérieur au prix minimum)				array_push($conditions_sql,"prix > $prix_min");			}			else if($prix_max!=-2)			{				// On ajoute la tranche de prix dans notre variable stockant la requête finale (le prix des annonces sera forcément inférieur au prix maximum)				array_push($conditions_sql,"prix < $prix_max");			}						// Si les années minimum et maximum sont mentionnées par l'utilisateur			if(($annee_min!=-2)&&($annee_max!=-2))			{				// On ajoute la tranche des années dans notre variable stockant la requête finale				array_push($conditions_sql,"annee BETWEEN $annee_min AND $annee_max");								// Si l'année minimum est supérieure à l'année maximum, on retourne une erreur				if($annee_min > $annee_max)				{					echo '					<script>						alert("Erreur : L\'année minimale doit être inférieure à l\'année maximale.");						location.href = "index.php?d=annonces&a=visualiser_annonce";					</script>';				}			}			// Si l'année minimum seulement est mentionnée par l'utilisateur			else if($annee_min!=-2)			{				// On ajoute la tranche des années dans notre variable stockant la requête finale (l'année des annonces sera forcément supérieure à l'année minimum)				array_push($conditions_sql,"annee > $annee_min");			}			// Si l'année maximum seulement est mentionnée par l'utilisateur			else if($annee_max!=-2)			{				// On ajoute la tranche des années dans notre variable stockant la requête finale (l'année des annonces sera forcément inférieure à l'année minimum)				array_push($conditions_sql,"annee < $annee_max");			}						// On requête la base de données pour sélectionner toutes les annonces qui ont été activées par l'administrateur			$sql_query = "SELECT * FROM annonces WHERE active = 1 ";			$i=0;			foreach($conditions_sql as $value){				$sql_query.=" AND ".$value;			}			$result = $connect->query($sql_query);			// Initialisation des variables contenant le nombre d'annonces ou d'occurences et initialisation du contenu			$nb_annonces=0;			$nb_occurrences="";			$contenu="";			while($row = mysqli_fetch_array($result))			{				// On incrémente le nombre d'annonces trouvées				$nb_annonces++;								// Si type_annonce = 1 (vente)				if($row[4] == 1)				{					$type_annonce = '<span class="mdl-chip__contact mdl-color--green mdl-color-text--white">V</span>									 <span class="mdl-chip__text">Catégorie : Vente</span>';				}				// Si type_annonce = 0 (achat)				else				{					$type_annonce = '<span class="mdl-chip__contact mdl-color--red mdl-color-text--white">A</span>									 <span class="mdl-chip__text">Catégorie : Achat</span>';				}								// Si online = 1 (visible sur le site vitrine)				if($row[15] == 1)				{					$online = '<img src="vue/images/led_green.png" width="20px" heigth="20px">&nbsp; Annonce également visible sur notre site internet</img>';				}				// Si online = 0 (non visible sur le site vitrine)				else				{					$online = '<img src="vue/images/led_red.png" width="20px" heigth="20px">&nbsp; Annonce non visible sur notre site internet</img>';				}								// Si telephone = 0 (ne souhaite pas être contacté par téléphone)				if($row[14] == 0)				{					$telephone = '';				}				// Si online = 0 (non visible sur le site vitrine)				else				{					$telephone = '<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary">									<span class="mdl-color-text--blue-100 material-icons" role="presentation">phone</span>&nbsp; Téléphone : '.$row[14].'								  </button>';				}								// Si la surface est non renseignée				if($row[10] == "Non renseignée")				{					// On ne renseigne pas l'unité					$unité_surface = "";				}				// Si la surface est renseignée				else				{					// On renseigne l'unité					$unité_surface = " m²";				}								// Si le PTV est non renseigné				if($row[11] == "Non renseigné")				{					// On ne renseigne pas l'unité					$unité_ptv = "";				}				// Si le PTV est renseigné				else				{					// On renseigne l'unité					$unité_ptv = " kg";				}								$list_photos = $row[5]; // image1.jpg,image2.png,image3.jpg				$photo = explode(",",$list_photos); // image1.jpg image2.png image3.jpg				$photos = "";								foreach ($photo as $key => $value){					if($photo[$key]!=""){						$photos .= '<img style="border-width:1px; border-style:solid; border-color:darkgrey;" height="160px" width="160px" src="vue/images/annonces/'.$photo[$key].'">&nbsp;&nbsp;</img>';					}				}				// On concatène la variable contenu de manière a y rentrer toutes les informations propres à l'affichage				$contenu .= '<div class="content-grid mdl-grid">								<div class="mdl-cell--10-col mdl-cell--3-col-phone color_bg">									<h6 style="font-size: 20px; padding-left: 2%;" class="animated fadeIn"><strong style="color: #607D8B;">'.$row[1].'</strong></h6>								</div>								<div class="mdl-cell--2-col mdl-cell--1-col-phone color_bg">									<div class="etiquette">										<span class="mdl-chip mdl-chip--contact animated fadeIn">											'.$type_annonce.'										</span>									</div>								</div>							</div>																				<div class="content-grid mdl-grid">																					<div class="mdl-cell--6-col mdl-cell--4-col-phone" style="margin-left:1.5%;">																						<h6 class="animated fadeIn"><strong>Prix : </strong><strong style="color: #2196F3;">'.$row[3].' €</strong></h6>																				<p class="animated fadeIn"><strong>Ville :</strong> '.$row[17].'<br/>															   <strong>Auteur :</strong> '.$row[16].' <br/>															   <strong>Date de publication :</strong> '.$row[18].'</p>															   											<h6 class="animated fadeIn"><strong>Photos</strong></h6>															   											<p class="animated zoomIn">'.$photos.'</p>																				<h6 class="animated fadeIn"><strong>Description</strong></h6>																				<p class="animated fadeIn">'.$row[2].'</p>								</div>																														<div class="mdl-cell--5-col mdl-cell--4-col-phone">																				<h6 class="animated fadeIn"><strong>Caractéristiques</strong></h6>																				<div class="gradient_color propriété">										<span class="propriété"><strong style="padding-left: 10px;">Marque :</strong></span>										<span class="valeur">'.$row[6].'</span>									</div>									<div class="gradient_color2">										<span class="propriété"><strong style="padding-left: 10px;">Modèle :</strong></span>										<span class="valeur">'.$row[7].'</span>									</div>									<div class="gradient_color2">										<span class="propriété"><strong style="padding-left: 10px;">Taille :</strong></span>										<span class="valeur">'.$row[8].'</span>									</div>									<div class="gradient_color2">										<span class="propriété"><strong style="padding-left: 10px;">Année :</strong></span>										<span class="valeur">'.$row[9].'</span>									</div>									<div class="gradient_color2">										<span class="propriété"><strong style="padding-left: 10px;">Surface :</strong></span>										<span class="valeur">'.$row[10].$unité_surface.'</span>									</div>									<div style="margin-bottom: 5%;" class="gradient_color2">										<span class="propriété"><strong style="padding-left: 10px;">Poids :</strong></span>										<span class="valeur">'.$row[11].$unité_ptv.'</span>									</div>																					'.$online.'									<br/><br/><br/>									<button id="email" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary">									  <span class="mdl-color-text--blue-100 material-icons" role="presentation">email</span>&nbsp; E-mail : '.$row[13].'									</button>									<br/><br/>									'.$telephone.'								</div>																		</div>																		<br/>';			}			// Si nb_annonces = 0 (aucune annonce trouvée)			if($nb_annonces == 0)			{				$nb_occurrences = '<div id="recherche_infructueuse" class="animated fadeIn">									<h3 style="text-align: center;">Désolé, votre recherche n\'a rien donné</h3>									<h5 style="text-align: center;">Aucune annonce ne correspond à vos critères</h5>									<div class="noresult"><img src="vue/images/noresult.png"></img></div>									<div id="recherche_bouton_retour" style="margin-top: 5%; text-align:center;">										<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary" onclick="location.href= \'index.php?d=annonces&a=visualiser_annonce\';" "style="margin-top: 5%;">											Retourner à la page de recherche										</button></div></div>';			}			// Si nb_annonces = 1 (on met la phrase du nombre d'occurrences trouvées au singulier)			else if($nb_annonces == 1)			{				$nb_occurrences = '<h5 class="animated fadeIn">'.$nb_annonces.' annonce correspond à vos critères</h5>';			}			// Si nb_annonces != 1 (on met la phrase du nombre d'occurrences trouvées au pluriel)			else			{				$nb_occurrences = '<h5 class="animated fadeIn">'.$nb_annonces.' annonces correspondent à vos critères</h5>';			}			$entete_contenu = '<div class="demo-card-wide mdl-card mdl-shadow--2dp">								<div class="mdl-card__title mdl-card-annonces__background animated slideInDown">									<h2 class="mdl-card__title-text">Visualisation des annonces en ligne</h2>								</div>													<div class="mdl-card__supporting-text card-background">																			'.$nb_occurrences.'									<br/>';			return $entete_contenu.$contenu;		}		// Méthode de la classe permettant de confirmer l'ajout d'une annonce		public function confirmAnnonce(){			if(isset($_POST["marque"]) && isset($_POST["modele"]) && isset($_POST["taille"])&& isset($_POST["annee"]) && isset($_POST["contenu_annonce"]) && isset($_POST["localisation"]))			{				// On vérifie que les champs obligatoires sont différents de la valeur par défaut				if(($_POST["marque"]!=-2) && ($_POST["modele"]!=-2) && ($_POST["taille"]!=-2) && ($_POST["annee"]!=-2) && ($_POST["localisation"]!=-2) && ($_POST["contenu_annonce"]!=''))				{					global $login_session;					// Récupération et stockage des variables que l'on récupère par le biais du formulaire					$titre = $_POST["titre"];															// Titre de l'annonce					$prix = $_POST["prix"];																// Prix de l'annonce					$type_annonce = $_POST["type_annonce"];												// Type d'annonce (Achat/Vente)					$surface = $_POST["surface"];														// Surface (m²)					$ptv = $_POST["ptv"];																// Poids total volant (kg)					$marque = $_POST["marque"];															// ID de la marque de la voile					$modele = $_POST["modele"];															// ID du modèle de la voile					$taille = $_POST["taille"];															// Taille de la voile					$annee = $_POST["annee"];															// Année de la voile					$telephone = $_POST["telephone"];													// Booléen de récupération du téléphone (0/1)					$online = $_POST["online"];															// Visible/Invisible en ligne					$contenu_annonce = $_POST["contenu_annonce"];										// Contenu de l'annonce					$localisation = str_replace("'", "\'",$_POST["localisation"]);						// Région de l'annonceur										// Récupération de l'identifiant de l'utilisateur qui poste l'annonce															// On initialise la variable permettant de dater l'annonce					date_default_timezone_set('Europe/Brussels');					$date_publication = date("d/m/Y");													// Date de publication de l'annonce															// Connexion à la base de données					$connect = $this->_bdd->openBDD();															// On interroge la base de données pour récupérer les informations propres à l'annonceur (auteur, ville, email et numéro de téléphone) pour créer l'annonce					$query = $connect->query ("SELECT nom, prenom, ville_expedition, telephone, email FROM clients WHERE email = '$login_session';");					if ($query->num_rows > 0) {						while($row = mysqli_fetch_array($query)) {							$auteur = $row[1]. " " .$row[0][0].".";										// Auteur de l'annonce (sous la forme : Julien T.)							$ville = $row[2];															// Ville de l'annonceur							$numero_telephone = $row[3];												// Numéro de téléphone de l'annonceur							$email = $row[4];															// Email de l'annonceur						}					}										// On récupère le 'nom' associé à l'id du fabriquant (correspond à la marque)					$query = $connect->query ("SELECT nom FROM fabricant WHERE id = '$marque';");					if ($query->num_rows >= 0) {						while($row = mysqli_fetch_array($query)) {							$marque = $row[0];															// Nom de la marque de la voile						}					}										// On récupère le 'nom' associé à l'id de la voile (correspond au modèle)					$query = $connect->query ("SELECT nom FROM voile WHERE id = '$modele';");					if ($query->num_rows >= 0) {						while($row = mysqli_fetch_array($query)) {							$modele = $row[0];															// Nom du modèle de la voile						}					}										// Si le contact par téléphone est actif, on stocke le numéro, sinon non					if ($telephone == 1) {$telephone = $numero_telephone;} else {$telephone = NULL;}	// Numéro de téléphone de l'annonceur					// Si la surface n'est pas renseignée, on le mentionne dans la base de données					if ($surface == -2) {$surface = "Non renseignée";}					// Si le PTV n'est pas renseigné, on le mentionne dans la base de données					if ($ptv == -2) {$ptv = "Non renseigné";}										// On traîte la variable contenant le titre pour éviter l'injection SQL					$titre = str_replace("'", "\'", $titre);															///////////////////////////////////////// DEBUG TESTS UNITAIRES ///////////////////////////////////					// echo "auteur=".$auteur."<br/>";					// echo "ville=".$ville."<br/>";					// echo "date_publication=".$date_publication."<br/>";					// echo "email=".$email."<br/>";					// echo "titre=".$titre."<br/>";					// echo "contenu_annonce=".$contenu_annonce."<br/>";					// echo "prix=".$prix."<br/>";					// echo "type_annonce=".$type_annonce."<br/>";					// echo "marque=".$marque."<br/>";					// echo "modele=".$modele."<br/>";					// echo "taille=".$taille."<br/>";					// echo "annee=".$annee."<br/>";					// echo "surface=".$surface."<br/>";					// echo "ptv=".$ptv."<br/>";					// echo "localisation=".$localisation."<br/>";					// echo "telephone=".$telephone."<br/>";					// echo "online=".$online."<br/>";					/////////////////////////////////////////////////////////////////////////////////////////////////										$db_names = "";										// Récupération des variables précédemment rentrées dans le formulaire					$type_annonce = ($_POST['type_annonce']);					$titre = $_POST['titre'];					$contenu_annonce = nl2br($_POST['contenu_annonce']);					$prix = $_POST['prix'];										// On definit la variable utilisée plus bas					$photos = "";										// On initialise l'état de la validité ou non de l'annonce					$valid_annonce = true;										// On ajoute les conditions qui doivent être remplies pour qu'une annonce soit valide										// Si l'annonceur décide de ne pas mettre une image minimum, cela retourne une erreur					if (count($_FILES['photos']['name'])==1 && $_FILES['photos']['name'][0]=='') {						$valid_annonce = false;						$this->_bdd->closeBDD();						echo '							<script>								if (window.confirm("Erreur : Il est obligatoire de devoir ajouter une image minimum. Vous devez procéder à la réécriture de votre annonce."))								{									location.href = "index.php?d=annonces&a=creer_annonce";								}								else								{									location.href ="index.php?d=annonces&a=creer_annonce";								}							</script>';					}					// Si l'annonceur décide de choisir plus de 3 images, cela retourne également une erreur					else if (count($_FILES['photos']['name'])>3) {						$valid_annonce = false;						$this->_bdd->closeBDD();						echo '							<script>								alert("Erreur : Vous ne pouvez ajouter que 3 images maximum.");							</script>';					}																				// On récupère les photos de l'annonceur					if(count($_FILES['photos']['tmp_name'])>=1){												foreach ($_FILES['photos']['tmp_name'] as $key => $val ) {														$filename = $_FILES['photos']['name'][$key];							$filename = str_replace(" ", "_", $filename);							$filesize = $_FILES['photos']['size'][$key];							$filetmpname = $_FILES['photos']['tmp_name'][$key];														// On spécifie le chemin où les images des annonces seront stockées							$target_dir = "vue/images/annonces/";							$target_file = $target_dir . basename($filename);							$uploadOk = 1;														$imageFileType = pathinfo($target_file,PATHINFO_EXTENSION);														// On vérifie si l'image est bien un fichier de type image							if(isset($_POST["submit"])) {																$check = getimagesize($filetmpname);																if($check !== false) {																		// Le fichier est bien une image, on valide l'uplaod									$uploadOk = 1;																	} else {																		// Le fichier n'est pas une image, on ne valide donc pas l'upload									$uploadOk = 0;																	}															}														// On vérifie si une image avec le même nom existe déjà							while (file_exists($target_file)) {																// Si c'est le cas, on change le nom en rajoutant des caractères afin de pouvoir l'héberger								$extension = pathinfo($filename, PATHINFO_EXTENSION);								$filename = preg_replace('/\\.[^.\\s]{3,4}$/', '', $filename);								$filename = $filename.strval(rand(0,9)).".".$extension;								$target_file = $target_dir . basename($filename);															}														// On vérifie que le fichier ne dépasse pas la taille maximale (maxi 5mo)							if ($filesize > 50000000) {																// Le fichier est trop volumineux, on ne valide pas l'upload								$uploadOk = 0;															}														// On vérifie que l'extension de l'image est sous la forme jpg,jpeg,png,gif seulement							if($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg"									&& $imageFileType != "gif" ) {																				// Si l'extension est différente, on ne valide pas l'upload										$uploadOk = 0;																			}																		// On vérifie que la variable $uploadOk est à 0 ou à 1, si elle est à 0 on affiche une erreur									if ($uploadOk == 0) {																				//echo "Erreur, votre image n'a pu être téléchargé.";																				// Si tout est OK, alors on procède à l'hébergement de l'image									} else {										if (move_uploaded_file($filetmpname, $target_file)) {																						$db_names.=$filename.",";																						// Sinon, on renvoie une erreur										} else {											//echo "Impossible, il y a eu une erreur durant le téléchargement de votre image.";										}																			}															}					}					else{$valid_annonce = false;}										// Si toutes les conditions sont remplies, on envoie l'annonce à l'administrateur pour validation					if($valid_annonce){						echo '							<script>								alert("Succès : Votre annonce a correctement été réceptionnée. Un administrateur procédera à sa vérification dans les plus brefs délais ainsi qu\'à sa publication si toutes les informations sont correctes.");							</script>';												$sql="INSERT INTO annonces VALUES ('', '$titre', '$contenu_annonce', '$prix', '$type_annonce', '$db_names', '$marque', '$modele', '$taille', '$annee', '$surface', '$ptv', '$localisation', '$email', '$telephone', '$online', '$auteur', '$ville', '$date_publication', '0')";												// Préparation du mail pour avertir de la création de l'annonce à l'utilisateur						$to      = $email;						$subject = 'Création de votre annonce '.$titre.' sur le site Ailipse Technique';						$message = 'Votre annonce <strong>'.$titre.'</strong> a bien été créée et ne demande plus qu\'à être validée par un administrateur. <br/><br/> Si vous changez d\'avis et que vous souhaitez la supprimer avant sa parution, vous pouvez grâce à l\'onglet "Supprimer une annonce" via le menu des annonces sur notre site.<br/><br/> Cet email est un message automatique, merci de ne pas y répondre. <br/><br/> <center><img src="http://www.ailipse-technique.fr/selAT/public/img/ailipse_logoweb.png"></img></center>';												$headers = "MIME-Version: 1.0" . "\r\n";						$headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";												// Envoi du mail						mail($to, $subject, $message, $headers);												// On execute la requête SQL qui enregistre l'annonce dans la base de données						$connect->query($sql);												// On ajoute également une notification pour prévenir l'administrateur d'une nouvelle annonce à valider						$connect->query("UPDATE notifications SET annonces = annonces+1 WHERE id = 1");												// On redirige l'utilisateur vers l'accueil de l'application						echo'<script>location.href = "index.php?d=vitrine&a=application";</script>';											}					// On ferme la connexion à la base de données					$this->_bdd->closeBDD();				}								// Si les conditions préalables ne sont pas correctement remplies, on retourne un message d'erreur				else {					echo '						<script>							alert("Erreur : Vous avez oublié de remplir un champ obligatoire. Les champs obligatoires sont mentionnés par un astérix.");							location.href = "index.php?d=annonces&a=creer_annonce";						</script>';				}							}		}		// Méthode de la classe permettant de sélectionner les annonces dans la base de données		public function selectAnnonces()		{			// Initialisation de la variable pour cibler une annonce à activer ou à supprimer			$target=$_GET["target"];						$connect = $this->_bdd->openBDD();			if(($target=="activateAnnonce")||($target=="delete"))	{$sql="SELECT id FROM annonces WHERE active = 0";}			else if($target=="notPanel")							{$sql="SELECT id FROM annonces";}			else													{$sql="SELECT id FROM annonces WHERE active = 1";}						// On sélectionne toutes les annonces actives, non activées ou les deux en fonction de la condition			$result = $connect->query($sql);	// Sélectionne toutes les annonces actives						while($row = mysqli_fetch_array($result))			{				// Renvoi les ids des annonces				echo $row[0].",";			}						// Fermeture de la connexion à la base de données			$this->_bdd->closeBDD();		}		// Méthode de la classe permettant de sélectionner dans la base de données les marques pour récupérer le modèle d'une voile		public function selectMarque()		{			// Connexion à la base de données			$connect = $this->_bdd->openBDD();						// On initialise la variable id_marque avec la variable contenue dans le formulaire			$id_marque=$_POST["id_marque"];						// On sélectionne l'id, le nom, la taille des modèles de voile qui correspond à l'id de la marque et qui est correctement validée			$sql="SELECT id, nom, nb_tail FROM `voile` WHERE id_const = $id_marque AND valider = 1";						// On envoie la requête à la BDD			$result = $connect->query($sql);						// On initialise la liste déroulante des modèles des voiles			$deroulant_modele="";						while($row = mysqli_fetch_array($result))			{				// On stocke dans la liste déroulante des modèles l'id et le nom de la voile				$deroulant_modele = $deroulant_modele."<option value=$row[0]>$row[1]</option>";			}						echo $deroulant_modele;			// Fermeture de la connexion à la base de données			$this->_bdd->closeBDD();		}		// Méthode de la classe permettant de sélectionner dans la base de données un modèle pour récupérer la taille d'une voile		public function selectModele()		{			// Connexion à la base de données			$connect = $this->_bdd->openBDD();						// On initialise la variable id_modele avec la variable contenue dans le formulaire			$id_modele=$_POST["id_modele"];						// On sélectionne la taille de la voile qui correspond à l'id du modèle et qui est correctement validé			$sql="SELECT nb_tail FROM `voile` WHERE id = $id_modele AND valider = 1";						// On envoie la requête			$result = $connect->query($sql);						while($row = mysqli_fetch_array($result))			{				// On stocke dans la variable nb_tailles le nombre de tailles que l'on récupère dans la BDD				$nb_tailles = $row[0];			}						// On sélectionne toutes les tailles dans la table voile_taille de la BDD			$sql="SELECT T1,T2,T3,T4,T5,T6,T7,T8,T9,T10 FROM `voile_taille` WHERE idvoile = $id_modele";						// On envoie la requête			$result = $connect->query($sql);						// On initialise la liste déroulante des tailles des voiles			$deroulant_taille="";						$row = mysqli_fetch_array($result);			for($i=0;$i<$nb_tailles;$i++)			{				if ($row[$i] != NULL)				{					// On stocke dans la liste déroulante des modèles l'id et le nom de la voile					$deroulant_taille = $deroulant_taille."<option value=$row[$i]>$row[$i]</option>";				}			}						echo $deroulant_taille;						// On ferme la connexion à la base de données			$this->_bdd->closeBDD();		}	}	}?>