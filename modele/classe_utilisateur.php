<?phpif(!class_exists("Utilisateur")){		class Utilisateur	{				//tous les attributs d'un utilisateur, operateur ou administrateur				protected $_nom;						//varchar 50		protected $_prenom;					//varchar 50		protected $_telephone;				//varchar 10		protected $_email;					//varchar 255		protected $_villeFacturation;			//varchar 80		protected $_adresseFacturation;		//varchar 80		protected $_codePostalFacturation;	//varchar 5		protected $_villeExpedition;			//varchar 80		protected $_adresseExpedition;		//varchar 80		protected $_codePostalExpedition;		//varchar 5		protected $_permissions;				// int 1		private $_bdd;				public function __construct()		{			$this->_bdd=new Bdd;		}				public function setMail($email)	// recupere le mail de l'utilisateur utilisé apres l'initialisation		{						$this->_email=$email;					}				public function recuData()		{			$this->_bdd=new Bdd;			$connexionBdd=$this->_bdd->openBDD();	//	ouverture de la base de données						$sql="select * from clients where email='$this->_email'";						$result = $connexionBdd->query($sql);	// execution de la requete												if ($result->num_rows > 0)			{		// verification que le compte existe								// output data of each row								while($row = $result->fetch_assoc())				{			// recuperation de tous les parametres										$this->_email = $row["email"];										$this->_prenom = $row["prenom"];										$this->_nom = $row["nom"];										$this->_password = $row["password"];										$this->_adresseExpedition = $row["rue_expedition"];										$this->_villeExpedition = $row["ville_expedition"];										$this->_codePostalExpedition = $row["code_postal_expedition"];										$this->_adresseFacturation = $row["rue_facturation"];										$this->_villeFacturation = $row["ville_facturation"];										$this->_codePostalFacturation = $row["code_postal_facturation"];										$this->_telephone=$row["telephone"];										$this->_permissions = $row["permissions"];									}			}			$this->_bdd->CloseBDD();		//fermeture de la base de données		}				public function modifierAvatar()		// essenciellement de l'affichage avec les valeurs du compte		{			global $login_session;						$avatar = "";						$connect =$this->_bdd->openBDD();			$sql="SELECT avatar FROM clients WHERE email='$login_session'";			$result = $connect->query($sql);						while ($row = $result->fetch_assoc()) {				$avatar = $row["avatar"];			}						return ('<div class="demo-card-wide mdl-card mdl-shadow--2dp">	<div class="mdl-card__title mdl-card-profil__background animated slideInDown">	<h2 class="mdl-card__title-text">'.$this->_prenom.' '.$this->_nom.'</h2>	</div>							<div class="mdl-card__supporting-text card-background">							<form action="index.php?d=utilisateur&a=avatar" method="post" enctype="multipart/form-data">							<div id="alert" >		</div>							<h5 class="animated fadeIn">Modifiez votre image de profil</h5>							<div class="content-grid mdl-grid">			<div class="mdl-cell--6-col animated fadeIn">									<h6>Changement de votre image de profil</h6>				<br/>									<input name="fileToUpload" type="file" style="display:none" id="upload-image"></input>									<div id="upload" class="drop-area">									   Cliquez-ici afin de pouvoir sélectionner votre nouvelle image de profil									</div>									<div id="thumbnail"></div>														<br/><br/>				<button name="submit" type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">					Changer votre avatar				</button>				</form>			</div>								<div class="mdl-cell--6-col animated fadeIn">									<h6>Aperçu de votre image de profil actuelle</h6>									<br/>									<img class="avatar-preview" src="vue/images/profil/'.$avatar.'.png" width="200px" height="200px"></img>								</div>	</div></div>');		}				public function modifierProfil()		// essenciellement de l'affichage avec les valeurs du compte				{			return ('<div class="demo-card-wide mdl-card mdl-shadow--2dp">	<div class="mdl-card__title mdl-card-profil__background animated slideInDown">	<h2 class="mdl-card__title-text">'.$this->_prenom.' '.$this->_nom.'</h2>	</div>							<div class="mdl-card__supporting-text card-background">							<form action="index.php?d=utilisateur&a=profil" method="post">							<div id="alert" >		</div>							<h5 class="animated fadeIn">Modifiez vos informations personnelles</h5>							<div class="content-grid mdl-grid">			<div class="mdl-cell animated fadeIn">				<h6>Identifiants de connexion</h6>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="email" class="mdl-textfield__input" id="email" type="text" value="'.$this->_email.'" readonly>					<label class="mdl-textfield__label" for="sample3">Adresse E-mail</label>					<div class="mdl-tooltip" data-mdl-for="email">					Pour changer votre email, veuillez contacter un administrateur.					</div>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="password" id="password" class="mdl-textfield__input" type="password">					<label class="mdl-textfield__label" for="sample3">Mot de passe</label>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="verification" id="password_check" class="mdl-textfield__input" type="password">					<label class="mdl-textfield__label" for="sample3">Confirmation du mot de passe</label>				  </div>													</div>								<div class="mdl-cell animated fadeIn">				<h6>Données personnelles</h6>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="nom" class="mdl-textfield__input" id="nom" type="text" value="'.$this->_nom.'" required="required">					<label class="mdl-textfield__label" for="sample3">Nom</label>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="prenom" class="mdl-textfield__input" id="prenom" type="text" value="'.$this->_prenom.'" required="required">					<label class="mdl-textfield__label" for="sample3">Prénom</label>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="telephone" class="mdl-textfield__input" id="telephone" type="text" value="'.$this->_telephone.'" required="required">					<label class="mdl-textfield__label" for="sample3">Téléphone</label>				  </div>								</div>								<div class="mdl-cell animated slideInRight">				<br/><br/><br/>				<img src="vue/images/profil_account.png" height="200px" width="200px">			</div>								<div class="mdl-cell animated fadeIn">				<h6>Adresse de facturation</h6>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="adresseFacturation" class="mdl-textfield__input" id="adresseFacturation" type="text" value="'.$this->_adresseFacturation.'" required="required">					<label class="mdl-textfield__label" for="sample3">Adresse</label>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="villeFacturation" class="mdl-textfield__input" id="villeFacturation" type="text" value="'.$this->_villeFacturation.'" required="required">					<label class="mdl-textfield__label" for="sample3">Ville</label>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="codePostalFacturation" class="mdl-textfield__input" id="codePostalFacturation" type="text" value="'.$this->_codePostalFacturation.'" required="required">					<label class="mdl-textfield__label" for="sample3">Code postal</label>				  </div>			</div>								<div class="mdl-cell animated fadeIn">				<h6>Adresse d\'expédition</h6>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="adresseExpedition" class="mdl-textfield__input" id="adresseExpedition" type="text" value="'.$this->_adresseExpedition.'" required="required">					<label class="mdl-textfield__label" for="sample3">Adresse</label>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="villeExpedition" class="mdl-textfield__input" id="villeExpedition" type="text" value="'.$this->_villeExpedition.'" required="required">					<label class="mdl-textfield__label" for="sample3">Ville</label>				  </div>									  <br/>									  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">					<input name="codePostalExpedition" class="mdl-textfield__input" id="codePostalExpedition" type="text" value="'.$this->_codePostalExpedition.'" required="required">					<label class="mdl-textfield__label" for="sample3">Code postal</label>				  </div>			</div>								<div class="mdl-cell animated slideInRight">				<br/><br/><br/>				<img src="vue/images/profil_shipping.png" height="200px" width="200px" style="margin-bottom: 50px;">			</div>								<div class="mdl-card__actions mdl-card--border card-background2 animated slideInUp">			<center>				<button  type="submit" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">					Valider les modifications apportées				</button>			</center>			</form>			<div/>	</div></div>');						// utilisation de modele/formulaires/update.php en POST pour valider les changements					}				public function validerModifierProfil()		{			// Connexion à la base de donnée			$connect =$this->_bdd->openBDD();						// Récupération des données du formulaire			$email=$_POST["email"];			$new_password=$_POST["password"];			$verification=$_POST["verification"];			$rue_expedition=$_POST["adresseExpedition"];			$code_postal_expedition=$_POST["codePostalExpedition"];			$ville_expedition=$_POST["villeExpedition"];			$rue_facturation=$_POST["adresseFacturation"];			$code_postal_facturation=$_POST["codePostalFacturation"];			$ville_facturation=$_POST["villeFacturation"];			$nom=$_POST["nom"];			$prenom=$_POST["prenom"];			$telephone=$_POST["telephone"];			// Vérifie que les mots de passe et la confirmation sont identiques			if(($new_password==$verification)&&($new_password!=""))			{				// Cryptage du mot de passe				$new_password=sha1($verification);				// Requête  de changement des données du client grâce à son id				$sql="UPDATE clients SET password='$new_password', nom='$nom',prenom='$prenom',telephone='$telephone', ville_expedition='$ville_expedition', rue_expedition='$rue_expedition',code_postal_expedition='$code_postal_expedition', ville_facturation='$ville_facturation', rue_facturation='$rue_facturation', code_postal_facturation='$code_postal_facturation' WHERE  email='$email'";							}			else			{				// Autre requete si le client ne souhaite pas changer son mot de passe				$sql="UPDATE clients SET  nom='$nom',prenom='$prenom',telephone='$telephone',ville_expedition='$ville_expedition', rue_expedition='$rue_expedition', code_postal_expedition='$code_postal_expedition', ville_facturation='$ville_facturation', rue_facturation='$rue_facturation', code_postal_facturation='$code_postal_facturation'  WHERE  email='$email'";			}			// Traite la requête			$connect->query($sql);						// Fermeture de la connexion à la base de données			$this->_bdd->closeBDD();						// Affiche une popup d'alert où l'on informe le client du bon déroulement du changement			echo "<script>alert('Modifications correctement apportées à votre profil.'); location.href = 'index.php?d=utilisateur&a=profil';</script>";		}				public function validerModifierAvatar()		{			// On récupère la variable de session			global $login_session;						// On formate l'adresse email de manière à créer une chaine unique pour l'avatar			$avatar = str_replace(".", "_",$login_session);		// Exemple : admin@test_fr			// Initialisation de la variable stockant le chemin où se trouve les images d'avatar			$target_dir = "vue/images/profil/";			$target_file = $target_dir . basename($avatar).".png";			$uploadOk = 1;			$imageFileType = pathinfo($target_file,PATHINFO_EXTENSION);			// On vérifie que l'image est bien de type image			if(isset($_POST["submit"])) {				$check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);				if($check !== false) {					$uploadOk = 1;				} else {					// Sinon on renvoie un message d'erreur à l'utilisateur					echo '						<script>							alert("Erreur : Votre fichier n\'est pas une image. Veuillez sélectionner une image puis réessayer.");							location.href = "index.php?d=utilisateur&a=avatar";						</script>';					$uploadOk = 0;				}			}			// On vérifie la taille maximum de l'image (5 mo max)			if ($_FILES["fileToUpload"]["size"] > 5000000) {				// Sinon on renvoie un message d'erreur à l'utilisateur				echo '					<script>						alert("Erreur : Votre image est trop volumineuse. Elle doit faire au maximum 5 mo.");						location.href = "index.php?d=utilisateur&a=avatar";					</script>';				$uploadOk = 0;			}			// On autorise que certains types de format d'images			if($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg"					&& $imageFileType != "gif" ) {						// Sinon on renvoie un message d'erreur à l'utilisateur						echo '							<script>								alert("Erreur : Votre image doit être au format : jpeg, jpg, png ou gif seulement. Changez de format puis réessayer.");								location.href = "index.php?d=utilisateur&a=avatar";							</script>';						$uploadOk = 0;					}					// On vérifie que la variable uploadOk est à 0					if ($uploadOk == 0) {						// On renvoie un message d'erreur à l'utilisateur						echo '							<script>								alert("Erreur : Une erreur s\'est produite durant l\'hébergement de votre image.");								location.href = "index.php?d=utilisateur&a=avatar";							</script>';						// En revanche si la variable est à 1, tout est ok					} else {						if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {							$connect = $this->_bdd->openBDD();							$sql="UPDATE clients SET avatar='$avatar' WHERE  email='$login_session'";							$connect->query($sql);							$this->_bdd->closeBDD();							// On envoie un message de succès à l'utilisateur							echo '								<script>									alert("Succès : Votre image de profil a correctement été modifiée.");									location.href = "index.php?d=utilisateur&a=avatar";								</script>';						} else {							// Sinon on renvoie un message d'erreur à l'utilisateur							echo '								<script>									alert("Erreur : Une erreur s\'est produite durant l\'hébergement de votre image.");									location.href = "index.php?d=utilisateur&a=avatar";								</script>';						}					}		}						public function suivi(){						$contenu='<div class="demo-card-wide mdl-card mdl-shadow--2dp">						<div class="mdl-card__title mdl-card-operateur__background animated slideInDown">							<h2 class="mdl-card__title-text">Vos suivis</h2>						</div>						<div class="mdl-card__supporting-text card-background">';			$connect= $this->_bdd->openBDD();			$result = $connect->query("SELECT id FROM clients WHERE email='$this->_email'");			$conteneur_suivis = [];			if(gettype($result)=="object"){				if($result->num_rows>0){					while($row = $result->fetch_array()){						$id_client = $row[0];					}				}			}			$result = $connect->query("SELECT id,date_ouverture,date_cloture,commentaire,statut FROM suivi WHERE id_client='$id_client' AND statut <> 'cloturé'");			if(gettype($result)=="object"){				if($result->num_rows>0){					while($row = $result->fetch_array()){						$contenu .= '<h5 class="animated fade-in">Suivi  '.$row[0].'</h5>										<table class="mdl-data-table mdl-js-data-table mdl-data-table mdl-shadow--2dp">											<thead>												<tr>													<th class="mdl-data-table__cell--non-numeric">Date d\'ouverture</th>													<th class="mdl-data-table__cell--non-numeric">Date cloture</th>									  				<th class="mdl-data-table__cell--non-numeric">Commentaire</th>													<th class="mdl-data-table__cell--non-numeric">Statut</th>												</tr>											</thead>										<tbody>											<tr>												<td class="mdl-data-table__cell--non-numeric">'.$row[1].'</td>												<td class="mdl-data-table__cell--non-numeric">'.$row[2].'</td>												<td class="mdl-data-table__cell--non-numeric">'.$row[3].'</td>												<td class="mdl-data-table__cell--non-numeric">'.$row[4].'</td>											</tr>										</tbody>									</table>';						$result_evenements = $connect->query("SELECT commentaire,date FROM suivi_evenement WHERE id_suivi='$row[0]'");						if(gettype($result_evenements)=="object"){							if($result_evenements->num_rows>0){								$contenu .= '<h5 class="animated fade-in">Événements du suivi</h5>											<table class="mdl-data-table mdl-js-data-table mdl-data-table mdl-shadow--2dp">												<thead>													<tr>														<th class="mdl-data-table__cell--non-numeric">Commentaire</th>														<th class="mdl-data-table__cell--non-numeric">Date</th>													</tr>												</thead>											<tbody>';								while($row_evenement = $result_evenements->fetch_array()){									$contenu .= '<tr>													<td class="mdl-data-table__cell--non-numeric">'.$row_evenement[0].'</td>													<td class="mdl-data-table__cell--non-numeric">'.$row_evenement[1].'</td>												</tr>';								}								$contenu.='		</tbody>											</table>										<hr>';							}						}						}				}			}			if(strlen($contenu)==272)			{				$contenu.='<div id="recherche_infructueuse" class="animated fadeIn">								<h3 style="text-align: center;">Aucun suivi à afficher</h3>								<h5 style="text-align: center;">Vous ne disposez actuellement d\'aucun suivi en cours</h5>								<div class="noresult"><img src="vue/images/noresult.png"></img></div>									<div id="recherche_bouton_retour">										<center><button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary" onclick="history.back();" style="margin-top: 100px;">											Retourner à la page précédente										</button></center>									</div>								</div>';			}			$this->_bdd->closeBDD();			$contenu.="</div></div>";			return $contenu;		}		public function visualiserControle() // COMING SOON		{																													}						public function deconnexion()		{			// On détruit toutes les sessions actuellement actives			if(session_destroy())			{				header("Location: index.php"); // on redirige vers une page			}					}			}	}?>