<?phpif(!class_exists("Notification")){		class Notification extends Bdd		{				private $_nbNotif;		// nombre de notification	nbCompte+nbAnnonce+nbControle				private $_nbCompte;		// nombre de comptes a valider				private $_nbAnnonce;		// nombre d'annonces a valider				private $_nbControle;	// nombre de controles a verifier								public function __construct()				{					}								public function updateNotif($permissions,$login_session)	// a pour but d'actualiser les notifications				{						$connect=$this->openBDD();	//connexion a la base de données						if($permissions==3)			{								$sql = "SELECT * FROM notifications";	// on recupere toutes les notifications								$result = $connect->query($sql);								if ($result->num_rows > 0) 		// verification si il y a au moins une ligne dans la bdd				{										// On traîte la requête										while($row = $result->fetch_assoc())										{												$this->_nbCompte = $row["comptes"];		// récuperation de la bdd du nombre de comptes a activer												$this->_nbControle= $row["saisies"];		// récuperation de la bdd du nombre de controles a activer												$this->_nbAnnonce = $row["annonces"];	// récuperation de la bdd du nombre d'annonces a activer											}					$this->_nbNotif=$this->_nbCompte+$this->_nbControle+$this->_nbAnnonce;	// modifie le nombre de notifications									}				else				{					$this->_nbNotif=0;									}											}			else{								$sql = "SELECT * FROM notifications_utilisateur WHERE email='$login_session' AND active = 1";								$result = $connect->query($sql);				$this->_nbNotif = $result->num_rows;							}						//$this->closeBDD();	// fermeture de la base de données					}				public function notifications()		{			global $login_session;			if(isset($login_session))			{				$connect = $this->openBDD();				$sql = "SELECT permissions FROM clients WHERE email='$login_session'";				$result = $connect->query($sql);				if ($result->num_rows > 0) 				{					while($row = $result->fetch_array())					{						$permissions = $row[0];		// Récupération des permissions de l'utilisateur					}				}				$this->updateNotif($permissions,$login_session);								if ($permissions == 1 || $permissions == 2)				{					if ($this->_nbNotif == 0)					{						return('<div class="mdl-layout__header-row">																	  <span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>																	  <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">																		<div class="material-icons">notifications_off</div>																									  </button>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																</div>');					}					else					{						return ('<div class="mdl-layout__header-row">									<span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>									<a style="text-decoration : none; color: #757575;" href="index.php?d=utilisateur&a=notifications"><button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon animated tada" id="hdrbtn">										<div class="material-icons mdl-badge mdl-badge--overlap">notifications</div>											<div class="mdl-badge mdl-badge--overlap animated bounce" data-badge="'.$this->_nbNotif.'"></div>									 </button></a>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																																</div>');					}				}				else				{					if ($this->_nbNotif == 0)					{						return('<div class="mdl-layout__header-row">																	  <span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>																	  <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">																		<div class="material-icons">notifications_off</div>																									  </button>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																</div>');																							}					else					{						return ('<div class="mdl-layout__header-row">									<span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>									<button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon animated tada" id="hdrbtn">										<div class="material-icons mdl-badge mdl-badge--overlap">notifications</div>											<div class="mdl-badge mdl-badge--overlap animated bounce" data-badge="'.$this->_nbNotif.'"></div>									 </button>																	<ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect mdl-menu--bottom-left" for="hdrbtn">										<a href="?d=administrateur&a=notifications" class="mdl-menu__item"><li class="mdl-menu__item"><strong>'.$this->_nbCompte.'</strong> compte(s) à  vérifier</li></a>										<a href="?d=administrateur&a=notifications" class="mdl-menu__item"><li class="mdl-menu__item"><strong>'.$this->_nbControle.'</strong> saisie(s) à  contrôler</li></a>										<a href="?d=administrateur&a=notifications" class="mdl-menu__item"><li class="mdl-menu__item"><strong>'.$this->_nbAnnonce.'</strong> annonce(s) à  valider</li></a>									</ul>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																																</div>');											}				}				$this->closeBDD();			}					}				public function gestionNotifications()		{			global $login_session;			// on se connecte à  la base de données			$connect=$this->openBDD();			$sql = "SELECT permissions FROM clients WHERE email = '$login_session'";			$result = $connect->query($sql);			while ($row = $result->fetch_array())			{				$permissions = $row[0];			}						if($permissions == 3)			{				$notifications_vide = "";								// on sélectionne dans la base de données tous les clients qui ne sont pas encore actifs				$clients="SELECT * FROM `clients` WHERE actif = 0";				$result=$connect->query($clients);				$client = "";				$notifications_comptes = "";								// on range tous les clients dans un tableau				if($result!= null)				{					while($row = $result->fetch_array())					{						$client = $client."						<tr id='$row[0]'>							<td class="."mdl-data-table__cell--non-numeric".">$row[1]</td>							<td>$row[3]</td>							<td>$row[4]</td>							<td>$row[5]</td>							<td>$row[7]</td>							<td>$row[8]</td>							<td>$row[6]</td>							<td>$row[10]</td>							<td>$row[11]</td>							<td>$row[9]</td>						</tr>";												$notifications_comptes = '<h5 class="animated fadeIn">Gestion des notifications</h5>												<br />												<h6 class="animated fadeIn">Nouveaux comptes à vérifier :</h6>												<table class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp animated fadeIn">													<thead>														<tr>															<th class="mdl-data-table__cell--non-numeric">E-mail</th>															<th>Nom</th>															<th>Prénom</th>															<th>Téléphone</th>															<th>Adresse expédition</th>															<th>Code postal expédition</th>															<th>Ville expédition</th>															<th>Adresse facturation</th>															<th>Code postal facturation</th>															<th>Ville facturation</th>														</tr>													</thead>													<tbody>														'.$client.'													</tbody>												</table>												<br />																												<button onClick="activate()" class="mdl-button mdl-js-button mdl-button--primary animated fadeIn">													Activer												</button>																												<button onClick="delete_notifications()" style="color: #F44336;" class="mdl-button mdl-js-button mdl-button--accent animated fadeIn">												  Supprimer												</button>';																	}				}								// on sélectionne aussi toutes les annonces qui n'ont pas encore été vérifiées				$annonces="SELECT * FROM `annonces` WHERE active = 0";				$result=$connect->query($annonces);				$annonce = "";				$notifications_annonces = "";								// on range tous les clients dans un tableau				if($result!= null)				{					while($row = $result->fetch_array())					{						// Traitements des données récupérées pour l'affichage						$list_photos = $row[5]; // image1.jpg,image2.png,image3.jpg						$photo = explode(",",$list_photos); // image1.jpg image2.png image3.jpg						$photos = "";						foreach ($photo as $key => $value){							if($photo[$key]!=""){								$photos .= "<img style='border:1px dotted darkgrey; margin: 2px;' src='vue/images/annonces/$photo[$key]' height='80px' width='80px'></img>";							}						}												if ($row[4] == 1){$type = "Vente";} else{$type = "Achat";}												$row[12] =  str_replace("_", " ",$row[12]);												if ($row[14] == 0) {$row[14] = "Non renseigné";}												if ($row[15] == 0) {$row[15] = "Non visible";}						else			   {$row[15] = "Visible";}												$annonce = $annonce."						<tr id='$row[0]'>							<td class="."mdl-data-table__cell--non-numeric".">$row[13]</td>							<td>$row[1]</td>							<td>$row[2]</td>							<td>$photos</td>							<td>$row[18]</td>							<td>$row[3]€</td>							<td>$type</td>							<td>$row[6]</td>							<td>$row[7]</td>							<td>$row[8]</td>							<td>$row[9]</td>							<td>$row[12]</td>							<td>$row[14]</td>							<td>$row[15]</td>						</tr>";												$notifications_annonces = '<h5 class="animated fadeIn">Gestion des notifications</h5>												   <br />												   <h6 class="animated fadeIn">Nouvelles annonces à valider :</h6>												<table class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp animated fadeIn">													<thead>														<tr>															<th class="mdl-data-table__cell--non-numeric">Email</th>															<th>Titre</th>															<th>Contenu</th>															<th>Photos</th>															<th>Date</th>															<th>Prix</th>															<th>Type</th>															<th>Marque</th>															<th>Modèle</th>															<th>Taille</th>															<th>Année</th>															<th>Localisation</th>															<th>Téléphone</th>															<th>En ligne</th>														</tr>													</thead>													<tbody>														'.$annonce.'													</tbody>												</table>																												<br />																												<button onClick="activate_annonce()" class="mdl-button mdl-js-button mdl-button--primary animated fadeIn">													Activer												</button>																												<button onClick="delete_annonce()" style="color: #F44336;" class="mdl-button mdl-js-button mdl-button--accent animated fadeIn">													Supprimer												</button>';											}				}								if($notifications_annonces == '' && $notifications_comptes == '')				{					$notifications_vide = '<div id="recherche_infructueuse" class="animated fadeIn">										<h3 style="text-align: center;"></h3>										<h5 style="text-align: center;">Vous n\'avez plus de notifications</h5>										<div class="noresult"><img src="vue/images/nonotifications.png" width="200px" height="200px"></img></div>										<div id="recherche_bouton_retour" style="margin-top: 5%; text-align:center;">											<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary" onclick="location.href= \'index.php?d=vitrine&a=application\';" "style="margin-top: 5%;">												Retourner à la page d\'accueil											</button></div></div>';				}				else				{					$notifications_vide = "";				}								// on ferme la connexion à  la base de données				$this->closeBDD();								// on affiche le contenu propre à  la gestion des notifications				return ('<div class="demo-card-wide mdl-card mdl-shadow--2dp">						<div class="mdl-card__title mdl-card-profil__background animated slideInDown">						<h2 class="mdl-card__title-text">Mes notifications</h2>						</div>					<div class="mdl-card__supporting-text card-background">				'.$notifications_vide.'				'.$notifications_comptes.'															'.$notifications_annonces.'																</div>');			}			else			{				$notifications = "";								$connect = $this->openBDD();				$sql = "SELECT * FROM notifications_utilisateur WHERE email = '$login_session' ORDER BY id DESC";				$result = $connect->query($sql);				$sql = "UPDATE notifications_utilisateur SET active = 0";				$connect->query($sql);								while($row = $result->fetch_array())				{					if ($row[3] == 1)					{						$notifications .=  '<div class="mdl-cell--12-col color_bg_accent">												<h6 style="font-size: 15px; padding-left: 2%;" class="animated fadeIn"><strong style="color: #fff;"><i class="mdl-color-text--blue-grey-200 material-icons" role="presentation">done</i> '.$row[2].'</strong></h6>											</div>';					}					else					{						$notifications .=  '<div class="mdl-cell--12-col color_bg">												<h6 style="font-size: 15px; padding-left: 2%;" class="animated fadeIn"><strong style="color: #607D8B;"><i class="mdl-color-text--blue-grey-200 material-icons" role="presentation">done</i> '.$row[2].'</strong></h6>											</div>';					}				}								$this->closeBDD();				return ('<div class="demo-card-wide mdl-card mdl-shadow--2dp">							<div class="mdl-card__title mdl-card-profil__background animated slideInDown">								<h2 class="mdl-card__title-text">Mes notifications</h2>							</div>														<div class="mdl-card__supporting-text card-background">								<div class="content-grid mdl-grid">									'.$notifications.'								</div>							<div/>						</div>');			}					}			}	}?>