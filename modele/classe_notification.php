<?php// Si la classe est déjà définie, on ne la rédéfinie pas (sécurité)if(!class_exists("Notification")){	// Création de la classe Notification	class Notification		{		// Attributs de la classe Notification		private $_nbNotif;		// nombre de notification (nbCompte+nbAnnonce+nbSaisies)		private $_nbCompte;		// nombre de comptes à vérifier		private $_nbAnnonce;	// nombre d'annonces à valider		private $_nbControle;	// nombre de saisies à contrôler		private $_bdd;			// objet de la base de données qui fait la liaison avec la base de données				// Constructeur de la classe Notification		public function __construct()		{			$this->_bdd=new Bdd;		}						// Méthode de la classe permettant d'actualiser les notifications		public function updateNotif($permissions,$login_session)				{			// Ouverture de la connexion à la base de données			$connect=$this->_bdd->openBDD();						// Si c'est un administrateur			if($permissions==3)			{				// On sélectionne toutes les notifications de la table notifications				$sql = "SELECT * FROM notifications";								$result = $connect->query($sql);								// On vérifie qu'il y a au moins une ligne dans la base de données				if ($result->num_rows > 0)				{					// On traîte la requête					while($row = $result->fetch_assoc())										{						// On récupère les notifications dans les attributs correspondants						$this->_nbCompte = $row["comptes"];						$this->_nbControle= $row["saisies"];						$this->_nbAnnonce = $row["annonces"];											}					// On ajoute toutes les notifications pour initialiser les compteur général de notifications					$this->_nbNotif=$this->_nbCompte+$this->_nbControle+$this->_nbAnnonce;				}				else				{					// Si il n'y a aucune ligne correspondante dans la base de données, alors on met le compteur général à 0					$this->_nbNotif=0;				}											}			// Si c'est un utilisateur ou un opérateur			else{				// On sélectionne toutes les notifications actives (non archivées) dans la table notifications_utilisateur				$sql = "SELECT * FROM notifications_utilisateur WHERE email='$login_session' AND active = 1";								// On traite la requête				$result = $connect->query($sql);				// On récupère les notifications propre à l'utilisateur				$this->_nbNotif = $result->num_rows;			}			// On ferme la connexion à la base de données			$this->_bdd->closeBDD();					}		// Méthode de la classe permettant l'affichage des notifications		public function notifications()		{			// On initialise la variable de session qui nous permettra de récupérer l'email de l'utilisateur connecté			global $login_session;			// On vérifie que l'utilisateur est bien connecté			if(isset($login_session))			{				// On ouvre la connexion à la base de données				$connect = $this->_bdd->openBDD();				// On vérifie les permissions de l'utilisateur connecté				$sql = "SELECT permissions FROM clients WHERE email='$login_session'";				$result = $connect->query($sql);				if ($result->num_rows > 0)				{					while($row = $result->fetch_array())					{						// On récupère dans une variable les permissions de l'utilisateur						$permissions = $row[0];					}				}				// On met à jour les notifications				$this->updateNotif($permissions,$login_session);								// Si l'utilisateur est un simple utilisateur ou bien un opérateur				if ($permissions == 1 || $permissions == 2)				{					// Si le compteur général des notifications est nul					if ($this->_nbNotif == 0)					{						// On affiche l'icone de notification qui correspond à cet état, impossible de cliquer						return('<div class="mdl-layout__header-row">																	  <span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>																	  <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">																		<div class="material-icons">notifications_off</div>																									  </button>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																</div>');					}					// Si le compteur général de notification n'est pas vide					else					{						// On affiche l'icone de notification qui correspond aux notifications utilisateur						return ('<div class="mdl-layout__header-row">									<span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>									<a style="text-decoration : none; color: #757575;" href="index.php?d=utilisateur&a=notifications"><button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon animated tada" id="hdrbtn">										<div class="material-icons mdl-badge mdl-badge--overlap">notifications</div>											<div class="mdl-badge mdl-badge--overlap animated bounce" data-badge="'.$this->_nbNotif.'"></div>									 </button></a>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																																</div>');					}									}				// Si c'est un administrateur				else				{					// Si le compteur général de notification est nul					if ($this->_nbNotif == 0)					{						// On affiche l'icone de notification qui correspond à cet état, impossible de cliquer						return('<div class="mdl-layout__header-row">																	  <span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>																	  <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">																		<div class="material-icons">notifications_off</div>																									  </button>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																</div>');																							}					// Si le compteur général de notification n'est pas vide					else					{						// On affiche l'icone de notification qui correspond aux notifications administrateur						return ('<div class="mdl-layout__header-row">									<span class="mdl-layout-title"><a href="index.php" style="text-decoration: none; color: #757575; font-weight: 400;">Ailipse Technique</a></span>									<button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon animated tada" id="hdrbtn">										<div class="material-icons mdl-badge mdl-badge--overlap">notifications</div>											<div class="mdl-badge mdl-badge--overlap animated bounce" data-badge="'.$this->_nbNotif.'"></div>									 </button>																	<ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect mdl-menu--bottom-left" for="hdrbtn">										<a href="?d=administrateur&a=notifications" class="mdl-menu__item"><li class="mdl-menu__item"><strong>'.$this->_nbCompte.'</strong> compte(s) à  vérifier</li></a>										<a href="?d=administrateur&a=notifications" class="mdl-menu__item"><li class="mdl-menu__item"><strong>'.$this->_nbControle.'</strong> saisie(s) à  contrôler</li></a>										<a href="?d=administrateur&a=notifications" class="mdl-menu__item"><li class="mdl-menu__item"><strong>'.$this->_nbAnnonce.'</strong> annonce(s) à  valider</li></a>									</ul>																	  <div class="mdl-layout-spacer"></div>																	  <a href="index.php?d=utilisateur&a=deconnexion">										<button class="mdl-button mdl-js-button mdl-button--accent">										  Déconnexion										</button>									  </a>																																</div>');											}				}				// On ferme la connexion à la base de données				$this->_bdd->closeBDD();			}					}		// Méthode de classe permettant la gestion des notifications		public function gestionNotifications()		{			// On initialise la variable de session qui nous permettra de récupérer l'email de l'utilisateur connecté			global $login_session;			// On ouvre la connexion à la base de données			$connect=$this->_bdd->openBDD();			// On vérifie les permissions de l'utilisateur connecté			$sql = "SELECT permissions FROM clients WHERE email = '$login_session'";			$result = $connect->query($sql);			while ($row = $result->fetch_array())			{				// On stocke dans une variable les permissions de l'utilisateur				$permissions = $row[0];			}			// Si c'est un administrateur			if($permissions == 3)			{				// On initialise la variable notifications_vide				$notifications_vide = "";								// On sélectionne dans la base de données tous les clients qui ne sont pas encore actifs				$clients="SELECT * FROM `clients` WHERE actif = 0";				$result=$connect->query($clients);				$client = "";				$notifications_comptes = "";								// On range tous les clients dans un tableau				if($result!= null)				{					while($row = $result->fetch_array())					{						$client = $client."						<tr id='$row[0]'>						<td class="."mdl-data-table__cell--non-numeric".">$row[1]</td>						<td>$row[3]</td>						<td>$row[4]</td>						<td>$row[5]</td>						<td>$row[7]</td>						<td>$row[8]</td>						<td>$row[6]</td>						<td>$row[10]</td>						<td>$row[11]</td>						<td>$row[9]</td>						</tr>";												// Variable permettant d'afficher le tableau récapitulatif lorsqu'une notification compte est active						$notifications_comptes = '<h5 class="animated fadeIn">Gestion des notifications</h5>												<br />												<h6 class="animated fadeIn">Nouveaux comptes à vérifier :</h6>												<table class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp animated fadeIn">													<thead>														<tr>															<th class="mdl-data-table__cell--non-numeric">E-mail</th>															<th>Nom</th>															<th>Prénom</th>															<th>Téléphone</th>															<th>Adresse expédition</th>															<th>Code postal expédition</th>															<th>Ville expédition</th>															<th>Adresse facturation</th>															<th>Code postal facturation</th>															<th>Ville facturation</th>														</tr>													</thead>													<tbody>														'.$client.'													</tbody>												</table>												<br />																												<button onClick="activate()" class="mdl-button mdl-js-button mdl-button--primary animated fadeIn">													Activer												</button>																												<button onClick="delete_notifications()" style="color: #F44336;" class="mdl-button mdl-js-button mdl-button--accent animated fadeIn">												  Supprimer												</button>';																	}				}								// On sélectionne aussi toutes les annonces qui n'ont pas encore été vérifiées				$annonces="SELECT * FROM `annonces` WHERE active = 0";				$result=$connect->query($annonces);				$annonce = "";				$notifications_annonces = "";								if($result!= null)				{					while($row = $result->fetch_array())					{						// Traitements des données récupérées pour l'affichage						$list_photos = $row[5]; 			// image1.jpg,image2.png,image3.jpg						$photo = explode(",",$list_photos); // image1.jpg image2.png image3.jpg						$photos = "";						// Initialisation de la variable permettant l'affichage des photos						foreach ($photo as $key => $value){							if($photo[$key]!=""){								$photos .= "<img style='border:1px dotted darkgrey; margin: 2px;' src='vue/images/annonces/$photo[$key]' height='80px' width='80px'></img>";							}						}												// Si le type de l'annonce est à 1 on stocke Vente, sinon Achat						if ($row[4] == 1){$type = "Vente";} else{$type = "Achat";}												// On formate le nom de la région pour remplacer les underscores par des espaces						$row[12] =  str_replace("_", " ",$row[12]);												// Si le champ téléphone est à 0 on affiche qu'il est non renseigné						if ($row[14] == 0) {$row[14] = "Non renseigné";}												// Si le champ en ligne est à 0 on affiche qu'elle est non visible sinon on affiche qu'elle est visible						if ($row[15] == 0) {$row[15] = "Non visible";}						else			   {$row[15] = "Visible";}												// On range toutes les annonces dans un tableau						$annonce = $annonce."						<tr id='$row[0]'>						<td class="."mdl-data-table__cell--non-numeric".">$row[13]</td>						<td>$row[1]</td>						<td>$row[2]</td>						<td>$photos</td>						<td>$row[18]</td>						<td>$row[3]€</td>						<td>$type</td>						<td>$row[6]</td>						<td>$row[7]</td>						<td>$row[8]</td>						<td>$row[9]</td>						<td>$row[12]</td>						<td>$row[14]</td>						<td>$row[15]</td>						</tr>";												// Variable permettant d'afficher le tableau récapitulatif lorsqu'une notification compte est active						$notifications_annonces = '<h5 class="animated fadeIn">Gestion des notifications</h5>												   <br />												   <h6 class="animated fadeIn">Nouvelles annonces à valider :</h6>												<table class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp animated fadeIn">													<thead>														<tr>															<th class="mdl-data-table__cell--non-numeric">Email</th>															<th>Titre</th>															<th>Contenu</th>															<th>Photos</th>															<th>Date</th>															<th>Prix</th>															<th>Type</th>															<th>Marque</th>															<th>Modèle</th>															<th>Taille</th>															<th>Année</th>															<th>Localisation</th>															<th>Téléphone</th>															<th>En ligne</th>														</tr>													</thead>													<tbody>														'.$annonce.'													</tbody>												</table>																												<br />																												<button onClick="activate_annonce()" class="mdl-button mdl-js-button mdl-button--primary animated fadeIn">													Activer												</button>																												<button onClick="delete_annonce()" style="color: #F44336;" class="mdl-button mdl-js-button mdl-button--accent animated fadeIn">													Supprimer												</button>';											}				}				// Si le contenu des variables notifications_annonces et notifications_comptes sont vides				if($notifications_annonces == '' && $notifications_comptes == '')				{					// On affiche un message disant que l'utilisateur n'a plus de notifications					$notifications_vide = '<div id="recherche_infructueuse" class="animated fadeIn">										<h3 style="text-align: center;"></h3>										<h5 style="text-align: center;">Vous n\'avez plus de notifications</h5>										<div class="noresult"><img src="vue/images/nonotifications.png" width="200px" height="200px"></img></div>										<div id="recherche_bouton_retour" style="margin-top: 5%; text-align:center;">											<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary" onclick="location.href= \'index.php?d=vitrine&a=application\';" style="margin-left: 5%;">												Retourner à la page d\'accueil											</button></div></div>';				}				else				{					// Sinon on met la variable vide					$notifications_vide = "";				}								// On ferme la connexion à  la base de données				$this->_bdd->closeBDD();																// On affiche le contenu propre à la gestion des notifications				return ('<div class="demo-card-wide mdl-card mdl-shadow--2dp">												<div class="mdl-card__title mdl-card-profil__background animated slideInDown">												<h2 class="mdl-card__title-text">Mes notifications</h2>												</div>											<div class="mdl-card__supporting-text card-background">										'.$notifications_vide.'																'.$notifications_comptes.'																'.$notifications_annonces.'																						</div>');			}			// Si c'est un utilisateur ou un opérateur			else			{				// Initialisation de la variable d'affichage notifications				$notifications = "";								// On ouvre la connexion à la base de données				$connect = $this->_bdd->openBDD();				// On sélectionne toutes les notifications utilisateur qui correspond à l'utilisateur connecté				$sql = "SELECT * FROM notifications_utilisateur WHERE email = '$login_session' ORDER BY id DESC";				$result = $connect->query($sql);				// On met à jour la table notifications_utilisateur pour que les notifications qui étaient actives deviennent archivées				$sql = "UPDATE notifications_utilisateur SET active = 0";				$connect->query($sql);								while($row = $result->fetch_array())				{					// Si la notification est active					if ($row[3] == 1)					{						// On concatène la variable d'affichage notifications pour formater l'affichage d'une notification active						$notifications .=  '<div class="mdl-cell--12-col color_bg_accent">												<h6 style="font-size: 15px; padding-left: 2%;" class="animated fadeIn"><strong style="color: #fff;"><i class="material-icons" role="presentation">done</i> '.$row[2].'</strong></h6>											</div>';					}					// Si la notification est archivée					else					{						// On concatène la variable d'affichage notifications pour formater l'affichage d'une notification archivée						$notifications .=  '<div class="mdl-cell--12-col color_bg">												<h6 style="font-size: 15px; padding-left: 2%;" class="animated fadeIn"><strong style="color: #607D8B;"><i class="mdl-color-text--blue-grey-200 material-icons" role="presentation">done</i> '.$row[2].'</strong></h6>											</div>';					}				}				// On ferme la connexion à la base de données				$this->_bdd->closeBDD();				// On retourne l'affichage				return ('<div class="demo-card-wide mdl-card mdl-shadow--2dp">							<div class="mdl-card__title mdl-card-profil__background animated slideInDown">								<h2 class="mdl-card__title-text">Mes notifications</h2>							</div>													<div class="mdl-card__supporting-text card-background">								<div class="content-grid mdl-grid">									'.$notifications.'								</div>							<div/>						</div>');			}					}					}	}?>